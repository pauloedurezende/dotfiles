---
name: Security Scanning

"on":
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run weekly on Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

env:
  PYTHON_VERSION: '3.12'

jobs:
  dependency-scan:
    name: Dependency Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install pip-audit
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit

      - name: Scan Python dependencies
        run: |
          echo "Scanning requirements.txt for vulnerabilities..."
          pip-audit -r requirements.txt --desc

      - name: Check for outdated packages
        continue-on-error: true
        run: |
          pip list --outdated --format=json > outdated.json
          if [ -s outdated.json ]; then
            echo "::warning::Found outdated packages:"
            python3 << 'EOF'
          import json
          data = json.load(open('outdated.json'))
          for pkg in data:
              n = pkg['name']
              v = pkg['version']
              l = pkg['latest_version']
              print(f'  - {n}: {v} -> {l}')
          EOF
          fi

  secrets-detection:
    name: Secrets Detection
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify vault encryption
        run: |
          echo "Checking vault files are encrypted..."
          for file in $(find . -name "vault.yml" -o -name "vault.yaml" | \
            grep -v venv/); do
            if head -n 1 "$file" | grep -q "^\$ANSIBLE_VAULT"; then
              echo "[OK] $file is encrypted"
            else
              echo "[FAIL] $file is NOT encrypted!"
              exit 1
            fi
          done

  permissions-check:
    name: File Permissions Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check sensitive file permissions
        run: |
          echo "Validating file permissions..."
          set -e  # Exit on error
          FOUND_ISSUES=0

          # Check script files for dangerous permissions
          echo "Checking script file permissions..."
          find . -type f -name "*.sh" -print0 | \
            while IFS= read -r -d '' file; do
            perms=$(stat -c "%a" "$file")
            perms_int=$((10#$perms))  # Convert to decimal for arithmetic

            # Check if world-writable (others can write)
            if [ $(($perms_int & 002)) -ne 0 ]; then
              echo "::error::$file is world-writable: $perms"
              exit 1
            fi

            # Check if group-writable and executable
            if [ $(($perms_int & 020)) -ne 0 ] && \
               [ $(($perms_int & 100)) -ne 0 ]; then
              echo "::warning::$file is group-writable and executable: $perms"
            fi

            # Warn if permissions are too open (anything beyond 755)
            if [ $perms_int -gt 755 ]; then
              echo "::warning::$file has overly permissive permissions: $perms"
            fi
          done

          # Ensure no world-writable files (better filtering)
          echo "Checking for world-writable files..."
          world_writable=$(find . -path ./.git -prune -o \
            -path ./venv -prune -o \
            -path ./env -prune -o \
            -type f -perm -o+w -print)
          if [ -n "$world_writable" ]; then
            echo "::error::Found world-writable files:"
            echo "$world_writable"
            exit 1
          fi

      - name: Check for executable files
        run: |
          # List all executable files for review
          echo "Executable files in repository:"
          exec_files=$(find . -path ./.git -prune -o \
            -path ./venv -prune -o \
            -path ./env -prune -o \
            -type f -executable -print)
          if [ -n "$exec_files" ]; then
            echo "$exec_files"
            # Check for suspicious SUID/SGID files
            suspicious=$(echo "$exec_files" | xargs -r stat -c "%n %a" | \
              awk '$2 ~ /^[4567]/ {print $1 " (SUID/SGID: " $2 ")"}')
            if [ -n "$suspicious" ]; then
              echo "::warning::Found SUID/SGID files:"
              echo "$suspicious"
            fi
          else
            echo "No executable files found"
          fi

  sast-analysis:
    name: Static Application Security Testing
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install bandit[toml] semgrep

      - name: Run Bandit on Python code
        continue-on-error: true
        run: |
          echo "Running Bandit security analysis..."
          bandit -r . -f json -o bandit-report.json || true

          # Parse and display results
          if [ -f bandit-report.json ]; then
            python3 << 'EOF'
          import json
          import sys

          try:
              with open('bandit-report.json', 'r') as f:
                  data = json.load(f)

              if data.get('results'):
                  print('Security issues found:')
                  for issue in data['results']:
                      severity = issue.get('issue_severity', 'UNKNOWN')
                      text = issue.get('issue_text', 'No description')
                      filename = issue.get('filename', 'unknown')
                      line = issue.get('line_number', 0)
                      print(f"  [{severity}] {text} - {filename}:{line}")
              else:
                  print('No security issues found by Bandit')
          except json.JSONDecodeError as e:
              print(f"::warning::Failed to parse Bandit report: {e}")
              sys.exit(0)
          except Exception as e:
              print(f"::warning::Error processing Bandit report: {e}")
              sys.exit(0)
          EOF
          fi

      - name: Ansible Security Best Practices Check
        run: |
          echo "Checking Ansible security best practices..."
          FOUND_ISSUES=0

          # Check for no_log on sensitive tasks
          echo "Checking for missing no_log on sensitive tasks..."

          # Use find for better handling of missing directories
          if [ -d "roles" ]; then
            FILES_TO_REVIEW=""
            # Find all task files efficiently
            find roles -type f -name "*.yml" -o -name "*.yaml" | \
            while IFS= read -r file; do
              # Single pass analysis with awk
              result=$(awk '
                BEGIN { has_exec=0; has_sensitive=0; has_nolog=0 }
                # Skip comments and empty lines
                /^[[:space:]]*#/ || /^[[:space:]]*$/ { next }
                # Check for execution modules
                /^[[:space:]]*(- name:|[[:space:]]*)?(shell|command|uri|raw):/ {
                  has_exec=1
                }
                # Check for sensitive content
                /(password|token|secret|private_key|credential|api_key)/ {
                  if (!/^[[:space:]]*#/) has_sensitive=1
                }
                # Check for no_log (various formats)
                /no_log:[[:space:]]*(true|yes|True|Yes|TRUE|YES|on|1)/ {
                  has_nolog=1
                }
                END {
                  if (has_exec && has_sensitive && !has_nolog) {
                    print "needs_review"
                  }
                }
              ' "$file")
              if [ "$result" = "needs_review" ]; then
                FILES_TO_REVIEW="$FILES_TO_REVIEW $file"
              fi
            done

            if [ -n "$FILES_TO_REVIEW" ]; then
              echo "::warning::Files that may need no_log review:"
              for f in $FILES_TO_REVIEW; do
                echo "  - $f"
              done
            else
              echo "All files with sensitive tasks appear to have no_log set"
            fi
          else
            echo "No roles directory found, skipping Ansible checks"
          fi

          # Check for become without password
          echo "Checking for unsafe privilege escalation..."
          # More robust become detection with word boundaries
          UNSAFE_BECOME=$(find . -name "*.yml" -o -name "*.yaml" | \
            xargs grep -l \
              "^[^#]*become:[[:space:]]*\(yes\|true\|True\|on\|1\)" \
              2>/dev/null | \
            while IFS= read -r file; do
              # Check if file has become_ask_pass or ansible_become_pass
              if ! grep -q \
                "become_ask_pass\|ansible_become_pass" "$file" 2>/dev/null
              then
                echo "$file"
              fi
            done | head -10)

          if [ -n "$UNSAFE_BECOME" ]; then
            echo "::warning::Found privilege escalation possibly without pass:"
            echo "$UNSAFE_BECOME"
            echo "Verify these files use vault or other secure methods for auth"
          fi

          # Exit with error if critical issues found
          if [ $FOUND_ISSUES -eq 1 ]; then
            echo "::error::Security check failed! Fix the issues above."
            exit 1
          fi

      - name: Run Semgrep security rules
        continue-on-error: true
        run: |
          echo "Running Semgrep security analysis..."
          semgrep --config=auto --json -o semgrep-report.json . || true

          if [ -f semgrep-report.json ]; then
            python3 << 'EOF'
          import json
          import sys

          try:
              with open('semgrep-report.json', 'r') as f:
                  data = json.load(f)

              results = data.get('results', [])
              if results:
                  print(f"Found {len(results)} potential issues")
                  # Show first 10 issues
                  for result in results[:10]:
                      check_id = result.get('check_id', 'unknown')
                      path = result.get('path', 'unknown')
                      start = result.get('start', {})
                      line = (start.get('line', '?')
                             if isinstance(start, dict) else '?')
                      print(f"  - {check_id}: {path}:{line}")

                  if len(results) > 10:
                      print(f"  ... and {len(results) - 10} more issues")
              else:
                  print('No issues found by Semgrep')
          except json.JSONDecodeError as e:
              print(f"::warning::Failed to parse Semgrep report: {e}")
              sys.exit(0)
          except Exception as e:
              print(f"::warning::Error processing Semgrep report: {e}")
              sys.exit(0)
          EOF
          fi

  security-report:
    name: Security Report Summary
    runs-on: ubuntu-latest
    needs:
      - dependency-scan
      - secrets-detection
      - permissions-check
      - sast-analysis
    if: always()

    steps:
      - name: Generate security summary
        run: |
          echo "## Security Scan Summary"
          echo ""

          # Function to format status with symbols
          format_status() {
            if [ "$1" = "success" ]; then
              echo "[PASS]"
            elif [ "$1" = "failure" ]; then
              echo "[FAIL]"
            elif [ "$1" = "skipped" ]; then
              echo "[SKIP]"
            else
              echo "[$1]"
            fi
          }

          # Print formatted table
          echo "+---------------------------+----------+"
          printf "| %-25s | %-8s |\n" "Security Check" "Status"
          echo "+---------------------------+----------+"
          printf "| %-25s | %-8s |\n" "Dependency Scan" \
            "$(format_status '${{ needs.dependency-scan.result }}')"
          printf "| %-25s | %-8s |\n" "Secrets Detection" \
            "$(format_status '${{ needs.secrets-detection.result }}')"
          printf "| %-25s | %-8s |\n" "Permissions Check" \
            "$(format_status '${{ needs.permissions-check.result }}')"
          printf "| %-25s | %-8s |\n" "SAST Analysis" \
            "$(format_status '${{ needs.sast-analysis.result }}')"
          echo "+---------------------------+----------+"
          echo ""

          if [ "${{ needs.dependency-scan.result }}" = "failure" ] || \
             [ "${{ needs.secrets-detection.result }}" = "failure" ] || \
             [ "${{ needs.permissions-check.result }}" = "failure" ]; then
            echo "[WARNING] Critical security issues detected."
            echo "Please review the failed checks above."
            exit 1
          elif [ "${{ needs.sast-analysis.result }}" = "failure" ]; then
            echo "[WARNING] Non-critical security issues in SAST analysis."
          else
            echo "[SUCCESS] All security checks passed!"
          fi
