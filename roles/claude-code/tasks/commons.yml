---
- name: Check Claude Code installation
  ansible.builtin.command: claude --version
  register: claude_code_version
  changed_when: false
  failed_when: false

- name: Install Claude Code
  ansible.builtin.shell: curl -fsSL https://claude.ai/install.sh | bash
  when: claude_code_version.rc != 0

- name: Create Claude Code configuration directory
  ansible.builtin.file:
    path: "{{ dotfiles_home }}/.claude"
    state: directory
    mode: '0755'
  when: claude_code_settings_enabled

- name: Copy Claude Code settings
  ansible.builtin.copy:
    src: settings.json
    dest: "{{ dotfiles_home }}/.claude/settings.json"
    mode: '0644'
    backup: true
  when: claude_code_settings_enabled

- name: Copy Claude Code statusline script
  ansible.builtin.copy:
    src: statusline.sh
    dest: "{{ dotfiles_home }}/.claude/statusline.sh"
    mode: '0755'
    backup: true
  when: claude_code_settings_enabled

- name: Install Claude Code skills
  ansible.builtin.command: >
    npx skills add {{ item.0.source }} -g -a claude-code -s {{ item.1 }} -y
  loop: "{{ claude_code_skills | subelements('skills') }}"
  register: claude_code_skill_install
  changed_when: "'already installed' not in claude_code_skill_install.stdout"
  failed_when: >
    claude_code_skill_install.rc != 0 and
    'already installed' not in claude_code_skill_install.stdout
  when: claude_code_skills_enabled
